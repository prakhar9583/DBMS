CREATE DATABASE MarketplaceDB;
USE MarketplaceDB;

CREATE TABLE Categories (
    category_ID INT AUTO_INCREMENT PRIMARY KEY,
    category_name VARCHAR(255) NOT NULL
);

CREATE TABLE Products (
    product_ID INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    price DECIMAL(10, 2),
    category_ID INT,
    FOREIGN KEY (category_ID) REFERENCES Categories(category_ID)
);

CREATE TABLE Warehouses (
    warehouse_ID INT AUTO_INCREMENT PRIMARY KEY,
    warehouse_name VARCHAR(255) NOT NULL,
    address VARCHAR(255) NOT NULL
);

CREATE TABLE Inventory (
    inventory_ID INT AUTO_INCREMENT PRIMARY KEY,
    product_ID INT,
    warehouse_ID INT,
    quantity_in_stock INT,
    last_stock_update DATE,
    FOREIGN KEY (product_ID) REFERENCES Products(product_ID),
    FOREIGN KEY (warehouse_ID) REFERENCES Warehouses(warehouse_ID)
);

CREATE TABLE Orders (
    order_ID INT AUTO_INCREMENT PRIMARY KEY,
    customer_ID INT,
    order_date DATE,
    shipping_address VARCHAR(255),
    order_status VARCHAR(50)
);

CREATE TABLE OrderItems (
    order_item_ID INT AUTO_INCREMENT PRIMARY KEY,
    order_ID INT,
    product_ID INT,
    quantity_ordered INT,
    unit_price DECIMAL(10, 2),
    FOREIGN KEY (order_ID) REFERENCES Orders(order_ID),
    FOREIGN KEY (product_ID) REFERENCES Products(product_ID)
);

CREATE TABLE Shipments (
    shipment_ID INT AUTO_INCREMENT PRIMARY KEY,
    order_ID INT,
    shipping_carrier VARCHAR(255),
    tracking_number VARCHAR(255),
    shipment_date DATE,
    FOREIGN KEY (order_ID) REFERENCES Orders(order_ID)
);


INSERT INTO Categories (category_name) VALUES 
('Refrigerators'),
('Washing Machines'),
('Air Conditioners'),
('Microwave Ovens'),
('Kitchen Appliances');

INSERT INTO Products (name, description, price, category_ID) VALUES 
('LG 260 L Double Door Refrigerator', 'Energy-efficient, sleek design refrigerator', 25000, 1),
('Samsung 7 kg Fully Automatic Washing Machine', 'High-quality, fully automatic washing machine', 30000, 2),
('Voltas 1.5 Ton Split AC', 'Effective cooling, energy-efficient AC', 35000, 3),
('Samsung 28 L Convection Microwave Oven', 'Microwave oven with multiple features', 15000, 4),
('Philips Mixer Grinder', 'Powerful mixer grinder for kitchen use', 3500, 5);

INSERT INTO Warehouses (warehouse_name, address) VALUES 
('Delhi Warehouse', 'Sector 21, New Delhi, India'),
('Mumbai Warehouse', 'Andheri, Mumbai, Maharashtra, India'),
('Bangalore Warehouse', 'Electronic City, Bangalore, Karnataka, India');

INSERT INTO Inventory (product_ID, warehouse_ID, quantity_in_stock, last_stock_update) VALUES 
(1, 1, 50, '2025-05-01'),
(2, 2, 30, '2025-05-02'),
(3, 3, 20, '2025-05-01'),
(4, 1, 10, '2025-05-01'),
(5, 2, 5, '2025-05-03');

INSERT INTO Orders (customer_ID, order_date, shipping_address, order_status) VALUES 
(101, '2025-05-03', '123, MG Road, Bangalore, Karnataka', 'Pending'),
(102, '2025-05-02', '456, Linking Road, Mumbai, Maharashtra', 'Shipped'),
(103, '2025-05-04', '789, Connaught Place, Delhi', 'Delivered');

INSERT INTO OrderItems (order_ID, product_ID, quantity_ordered, unit_price) VALUES 
(1, 1, 1, 25000),
(1, 5, 2, 3500),
(2, 2, 1, 30000),
(3, 3, 1, 35000);

INSERT INTO Shipments (order_ID, shipping_carrier, tracking_number, shipment_date) VALUES 
(2, 'BlueDart', 'BD123456', '2025-05-02'),
(3, 'DTDC', 'DT987654', '2025-05-04');

DELIMITER //

CREATE FUNCTION IsProductOutOfStock(product_id INT) 
RETURNS BOOLEAN
DETERMINISTIC
BEGIN
    DECLARE total_stock INT;

    -- Calculate total stock for the product across all warehouses
    SELECT SUM(quantity_in_stock) INTO total_stock
    FROM Inventory
    WHERE product_ID = product_id;

    -- Return TRUE if the total stock is zero, otherwise FALSE
    IF total_stock = 0 THEN
        RETURN TRUE;
    ELSE
        RETURN FALSE;
    END IF;
END //

DELIMITER ;

SELECT IsProductOutOfStock(1);


SELECT 
    c.category_name,
    SUM(oi.quantity_ordered * oi.unit_price) AS total_sales
FROM 
    Categories c
JOIN 
    Products p ON c.category_ID = p.category_ID
JOIN 
    OrderItems oi ON p.product_ID = oi.product_ID
GROUP BY 
    c.category_name;


DELIMITER //

CREATE TRIGGER DecreaseStockAfterOrder
AFTER INSERT ON OrderItems
FOR EACH ROW
BEGIN
    DECLARE stock_quantity INT;

    SELECT quantity_in_stock INTO stock_quantity
    FROM Inventory
    WHERE product_ID = NEW.product_ID
    LIMIT 1;

    UPDATE Inventory
    SET quantity_in_stock = stock_quantity - NEW.quantity_ordered
    WHERE product_ID = NEW.product_ID;
END //

DELIMITER ;

INSERT INTO OrderItems (order_ID, product_ID, quantity_ordered, unit_price)
VALUES (1, 1, 5, 10000);




SELECT 
    p.product_ID,
    p.name,
    p.price
FROM 
    Products p
JOIN 
    Categories c ON p.category_ID = c.category_ID
WHERE 
    c.category_name = 'Washing Machines'

UNION

SELECT 
    p.product_ID,
    p.name,
    p.price
FROM 
    Products p
WHERE 
    p.price > 900;


SELECT 
    p.product_ID,
    p.name,
    p.price
FROM 
    Products p
JOIN 
    Categories c ON p.category_ID = c.category_ID
WHERE 
    c.category_name = 'Washing Machines';


SELECT 
    p.product_ID,
    p.name,
    SUM(oi.quantity_ordered * oi.unit_price) AS total_revenue
FROM 
    Products p
JOIN 
    OrderItems oi ON p.product_ID = oi.product_ID
GROUP BY 
    p.product_ID, p.name;








